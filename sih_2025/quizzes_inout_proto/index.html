<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mental Health Check-in</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8;
        }
        .screen {
            transition: opacity 0.3s ease-in-out;
        }
        .hidden {
            display: none;
        }
    </style>
</head>
<body class="bg-slate-100 flex items-center justify-center min-h-screen">

    <div class="w-full max-w-xl mx-auto bg-white rounded-2xl shadow-lg p-6 sm:p-8 space-y-6">

        <!-- Welcome Screen -->
        <div id="welcome-screen" class="screen">
            <div class="text-center">
                <h1 class="text-3xl font-bold text-slate-800">Mental Health & Well-being</h1>
                <p class="text-slate-600 mt-2">A Confidential Check-in Tool</p>
            </div>
            <div class="mt-6 p-4 bg-blue-50 border-l-4 border-blue-500 rounded-r-lg">
                <h3 class="font-semibold text-blue-800">Important Disclaimer</h3>
                <p class="text-blue-700 mt-1 text-sm">This is a screening tool, not a diagnostic tool. The results are for informational purposes only and cannot replace a professional medical consultation.</p>
            </div>
            <div class="mt-6">
                <label for="userId" class="block text-sm font-medium text-slate-700">Enter a Nickname or Anonymous ID</label>
                <input type="text" id="userId" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md text-sm shadow-sm placeholder-slate-400 focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-blue-500" placeholder="e.g., BlueJay21">
            </div>
            <button id="start-btn" class="mt-6 w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-transform transform hover:scale-105">Start Check-in</button>
        </div>

        <!-- Quiz Screen -->
        <div id="quiz-screen" class="screen hidden">
            <h2 id="quiz-title" class="text-2xl font-bold text-slate-800 text-center"></h2>
            <p class="text-center text-slate-500 mt-1">Over the last 2 weeks, how often have you been bothered by:</p>
            <div class="mt-4 w-full bg-slate-200 rounded-full h-2.5">
                <div id="progress-bar" class="bg-blue-600 h-2.5 rounded-full" style="width: 0%"></div>
            </div>
            <div id="question-container" class="mt-6 text-center">
                <p id="question-text" class="text-lg font-medium text-slate-700 min-h-[80px] flex items-center justify-center"></p>
                <div id="options-container" class="mt-4 grid grid-cols-1 sm:grid-cols-2 gap-3"></div>
            </div>
        </div>

        <!-- Results Screen -->
        <div id="results-screen" class="screen hidden">
            <div class="text-center">
                 <h1 class="text-3xl font-bold text-slate-800">Your Results</h1>
                 <p class="text-slate-600 mt-2">Here is a summary of your confidential check-in.</p>
            </div>
            <div id="results-summary" class="mt-6 space-y-4"></div>
             <div class="mt-8 p-4 bg-green-50 border-l-4 border-green-500 rounded-r-lg">
                <h3 class="font-semibold text-green-800">Helpful Resources</h3>
                <ul class="mt-2 text-sm text-green-700 list-disc list-inside space-y-1">
                    <li><b>National Suicide Prevention Lifeline:</b> Call or text 988</li>
                    <li><b>Crisis Text Line:</b> Text HOME to 741741</li>
                </ul>
             </div>
            <button id="restart-btn" class="mt-6 w-full bg-slate-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-slate-700">Start New Check-in</button>
        </div>
        
        <!-- Loading Spinner -->
        <div id="loading-spinner" class="screen hidden text-center p-8">
             <svg class="animate-spin h-10 w-10 text-blue-600 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <p class="mt-4 text-slate-600 font-medium">Saving your results...</p>
        </div>

    </div>

    <script>
        // --- App State & DOM Elements ---
        let currentQuiz = '', currentQuestionIndex = 0, userId = '', phq9Answers = [], gad7Answers = [];
        const screens = { welcome: document.getElementById('welcome-screen'), quiz: document.getElementById('quiz-screen'), results: document.getElementById('results-screen'), loading: document.getElementById('loading-spinner') };
        
        // --- Questionnaire Data ---
        const PHQ9_QUESTIONS = ["Little interest or pleasure in doing things", "Feeling down, depressed, or hopeless", "Trouble falling or staying asleep, or sleeping too much", "Feeling tired or having little energy", "Poor appetite or overeating", "Feeling bad about yourself â€” or that you are a failure", "Trouble concentrating on things, like reading or watching TV", "Moving or speaking so slowly people could have noticed? Or the opposite", "Thoughts that you would be better off dead or hurting yourself"];
        const GAD7_QUESTIONS = ["Feeling nervous, anxious or on edge", "Not being able to stop or control worrying", "Worrying too much about different things", "Trouble relaxing", "Being so restless that it is hard to sit still", "Becoming easily annoyed or irritable", "Feeling afraid as if something awful might happen"];
        const RESPONSE_OPTIONS = [{text: "Not at all", value: 0}, {text: "Several days", value: 1}, {text: "More than half the days", value: 2}, {text: "Nearly every day", value: 3}];

        const showScreen = (screenName) => {
            Object.values(screens).forEach(s => s.classList.add('hidden'));
            if(screens[screenName]) screens[screenName].classList.remove('hidden');
        };

        const startQuiz = (quizName) => {
            currentQuiz = quizName;
            currentQuestionIndex = 0;
            if (quizName === 'phq9') {
                document.getElementById('quiz-title').textContent = 'Depression Check-in (PHQ-9)';
                phq9Answers = [];
            } else {
                document.getElementById('quiz-title').textContent = 'Anxiety Check-in (GAD-7)';
                gad7Answers = [];
            }
            renderQuestion();
            showScreen('quiz');
        };

        const renderQuestion = () => {
            const questions = currentQuiz === 'phq9' ? PHQ9_QUESTIONS : GAD7_QUESTIONS;
            const qContainer = document.getElementById('question-container');
            
            if (currentQuestionIndex >= questions.length) {
                return advanceQuiz();
            }

            // Update progress bar
            const progress = ((currentQuestionIndex) / questions.length) * 100;
            document.getElementById('progress-bar').style.width = `${progress}%`;

            document.getElementById('question-text').textContent = `${currentQuestionIndex + 1}. ${questions[currentQuestionIndex]}`;
            const optionsEl = document.getElementById('options-container');
            optionsEl.innerHTML = '';
            RESPONSE_OPTIONS.forEach(opt => {
                const button = document.createElement('button');
                button.textContent = opt.text;
                button.className = 'w-full bg-slate-100 text-slate-700 font-semibold py-3 px-4 rounded-lg hover:bg-blue-100 transition-colors';
                button.onclick = () => handleAnswer(opt.value);
                optionsEl.appendChild(button);
            });
        };

        const handleAnswer = (value) => {
            const questions = currentQuiz === 'phq9' ? PHQ9_QUESTIONS : GAD7_QUESTIONS;
            const answer = { question: questions[currentQuestionIndex], answer: value };
            if (currentQuiz === 'phq9') phq9Answers.push(answer);
            else gad7Answers.push(answer);
            currentQuestionIndex++;
            renderQuestion();
        };

        const advanceQuiz = () => {
            if (currentQuiz === 'phq9') startQuiz('gad7');
            else showResults();
        };

        const interpretScore = (score, type) => {
            if (type === 'phq9') {
                if (score <= 4) return "Minimal depression"; if (score <= 9) return "Mild depression"; if (score <= 14) return "Moderate depression"; if (score <= 19) return "Moderately severe depression"; return "Severe depression";
            } else { // gad7
                if (score <= 4) return "Minimal anxiety"; if (score <= 9) return "Mild anxiety"; if (score <= 14) return "Moderate anxiety"; return "Severe anxiety";
            }
        };

        const showResults = async () => {
            showScreen('loading');
            const phq9Score = phq9Answers.reduce((s, a) => s + a.answer, 0);
            const gad7Score = gad7Answers.reduce((s, a) => s + a.answer, 0);
            
            const resultsData = {
                userId: userId,
                timestamp: new Date().toISOString(),
                phq9: { score: phq9Score, interpretation: interpretScore(phq9Score, 'phq9'), responses: phq9Answers },
                gad7: { score: gad7Score, interpretation: interpretScore(gad7Score, 'gad7'), responses: gad7Answers }
            };

            // --- Send data to the Python Backend ---
            try {
                // UPDATED: The URL is now relative, pointing to the same server.
                const response = await fetch('/api/save-results', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(resultsData),
                });
                if (!response.ok) console.error("Failed to save results.");
                else console.log("Results saved successfully.");
            } catch (error) {
                console.error("Error sending data to the server:", error);
                alert("Could not connect to the backend server. Please make sure it is running.");
            }

            document.getElementById('results-summary').innerHTML = `
                <div class="bg-slate-50 p-4 rounded-lg">
                    <h3 class="font-bold text-slate-700">Depression (PHQ-9) Score</h3>
                    <p class="text-3xl font-bold text-blue-600">${phq9Score} <span class="text-lg font-medium text-slate-500">/ 27</span></p>
                    <p class="font-semibold text-slate-800">${resultsData.phq9.interpretation}</p>
                </div>
                <div class="bg-slate-50 p-4 rounded-lg">
                    <h3 class="font-bold text-slate-700">Anxiety (GAD-7) Score</h3>
                    <p class="text-3xl font-bold text-purple-600">${gad7Score} <span class="text-lg font-medium text-slate-500">/ 21</span></p>
                    <p class="font-semibold text-slate-800">${resultsData.gad7.interpretation}</p>
                </div>`;
            showScreen('results');
        };

        // --- Event Listeners ---
        document.getElementById('start-btn').addEventListener('click', () => {
            userId = document.getElementById('userId').value.trim();
            if (!userId) {
                alert('Please enter a nickname or anonymous ID.');
                return;
            }
            startQuiz('phq9');
        });

        document.getElementById('restart-btn').addEventListener('click', () => {
            document.getElementById('userId').value = '';
            showScreen('welcome');
        });
        
        // --- App Initialization ---
        window.addEventListener('load', () => showScreen('welcome'));
    </script>
</body>
</html>

